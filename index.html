<html>
<head>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200;0,300;0,400;0,600;0,700;0,800;0,900;1,200;1,300;1,400;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/pure-min.css" integrity="sha384-cg6SkqEOCV1NbJoCu11+bm0NvBRc8IYLRGXkmNrqUBfTjmMYwNKPWBTIKyw9mHNJ" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-responsive-min.css">
    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/vuejs-datepicker"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>NearHear</title>
</head>
<body>
    <style scoped="">
        #app { font-family: "Nunito", sans-serif !important; letter-spacing: initial !important; width:100%; letter-spacing: initial;}
        #app .vdp-datepicker__calendar { color: black; }
        /* #app .pure-g { padding-bottom: 2em; padding-top: 2em; letter-spacing: initial; } */
        #app .pure-g [class *= "pure-u"] {  font-family: "Nunito", sans-serif !important; letter-spacing: initial; }
        #app .pure-g {padding: 1em 0;}
        #app input, textarea, select { margin:.5em; }
        #blurb { text-align: center; }
        #footer { font-style: italic; color: cornsilk; position: fixed;  bottom: 0; right: 0; background: #000; width: 100%; height: 1em; text-align: right; padding: .5em; font-size: .75em; }
        #main-nav { margin-top: 7% }
        #main-nav ul { float:right }
        #main-nav .pure-menu-link { font-size: 1.3em; }
        #nh-logo { position: absolute; max-width: 18em; left: 5%; }
        #tagline { font-size: 1.5em; line-height: 6em; position: absolute; right: 5%;   }
       
        body {
            background-color:cornsilk;
            background-size: 50px;
            background-image: url(assets/nh_diag.svg);
            color: #201a23;
            min-height: 200px;
        }        
        body .container {
            font-family: Nunito !important;
            font-weight: lighter;
            font-size: 1.2em;
        }
        p {     
            text-align: justify;
            line-height: 1.5em;
            padding-bottom: 1em;
        }
        a, a:active, a:visited {
            color: deeppink;
            font-weight: bold;
        }

        .light-bg {
            margin-top:2em;
            color: #201a23;
            min-height: 200px;
        }

        .show-bg {
            background-image: url('./assets/show.png');
            background-repeat: no-repeat;
            background-color: #000;
            background-position: center;
            color: cornsilk;
        }
        .dark-bg, .dark-bg-1 {
            background-color:#133c4c;
            background-size: 50px;
            color: cornsilk;
            min-height: 200px;
            background-image: url(assets/nh_diag.svg);

        }
        .dark-bg-1 { 
            background-color:#23132b; 
            background-image: url(assets/nh_diag.svg);
        }
        .pop-bg {
            background-color:deeppink;
            background-size: 50px;
            /* background-image: url(assets/nh_diag.svg); */
            color: cornsilk;
            min-height: 200px;
        }
        .mid-bg {
            background-color:#352b3a;
            background-size: 50px;
            background-image: url(assets/nh_diag.svg);
            color: cornsilk;
            min-height: 200px;
        }
        .pure-button-primary,
        .button-success,
        .button-error,
        .button-warning,
        .button-secondary {
            color: white;
            border-radius: 8px;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
        }
        .pure-button-primary { 
            background-color:#00e3f6ff; 
            color:black; 
        }
        .filter-wrapper { float:left; width: 40%;}
        /* .datepicker-wrap { padding-top: 1em; padding-left: 3em; } */
        ol { list-style: none; counter-reset: my-awesome-counter; padding-left: 0.5em; }
        ol li { counter-increment: my-awesome-counter; }
        ol li::before { content: counter(my-awesome-counter) ". "; color: deeppink; font-weight: bold; }
    
        @media screen and (max-width: 64em) {
            #blurb {max-width: initial;}
            #app h1 {font-size: 1.5em; letter-spacing: initial; }
            #tagline { display: none; width:0; height: 0; }
            #app input, textarea { max-width: 9em }
            .nh-logo img { left: 1em; transform: translate(0, -50%); }
        } 

    @keyframes ldio-ocss36wta5n-o {
        0%    { opacity: 1; transform: translate(0 0) }
       49.99% { opacity: 1; transform: translate(40px,0) }
       50%    { opacity: 0; transform: translate(40px,0) }
      100%    { opacity: 0; transform: translate(0,0) }
    }
    @keyframes ldio-ocss36wta5n {
        0% { transform: translate(0,0) }
       50% { transform: translate(40px,0) }
      100% { transform: translate(0,0) }
    }
    .ldio-ocss36wta5n div {
      position: absolute;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      top: 30px;
      left: 10px;
    }
    .ldio-ocss36wta5n div:nth-child(1) {
      background: #382044;
      animation: ldio-ocss36wta5n 1s linear infinite;
      animation-delay: -0.5s;
    }
    .ldio-ocss36wta5n div:nth-child(2) {
      background: #00e5ff;
      animation: ldio-ocss36wta5n 1s linear infinite;
      animation-delay: 0s;
    }
    .ldio-ocss36wta5n div:nth-child(3) {
      background: #382044;
      animation: ldio-ocss36wta5n-o 1s linear infinite;
      animation-delay: -0.5s;
    }
    .loadingio-spinner-dual-ball-ffelmax3riq {
      width: 58px;
      height: 58px;
      overflow: hidden;
      background: none;
    }
    .ldio-ocss36wta5n {
      width: 100%;
      height: 100%;
      position: relative;
      transform: translateZ(0) scale(0.58);
      backface-visibility: hidden;
      transform-origin: 0 0; /* see note above */
    }
    .ldio-ocss36wta5n div { box-sizing: content-box; }
    /* generated by https://loading.io/ */
    </style>
      
    <div id="app" class="container gu" >
        <div id="top-nav">
            <div class="pure-g dark-bg">
                <div class="pure-u-1 pure-u-md-1-3">
                    <div id="tagline">Discover music online. See it nearby.</div>
                    <img id="nh-logo" src="./assets/nh.png" alt="NearHear"></img>
                </div>
            </div>
        </div>

        <div class="pure-g show-bg">
            <div class="pure-u-1 pure-u-md-1-5">
            </div>
            <div class="pure-u-1 pure-u-md-3-5">
                <h1 id="blurb">NearHear allows you to create Spotify playlists of artists with upcoming
                    performances in your area. Listen to old favorites or discover new ones,
                    then go see them live.</h1>
            </div>
        </div>

        <div class="pure-g dark-bg">

            <div class="pure-u-1 pure-u-md-1-3">
            </div>
            <div class="pure-u-1 pure-u-md-1-3">
                <h1>How It Works &#128640;</h1>
                <ol>
                    <li>Authorize with Spotify</li>
                    <li>Pick a city and a time frame.</li>
                    <li>Filter by your favorite venues and genres.</li>
                    <li>Let Nearhear create a playlist and send it your spotify.</li>
                    <p>That's it. When you log into spotify, you should see a playlist with tracks custom tailored to your area.</p>
                    <p>NearHear is all about supporting live music, so once you discover an artist you like, checkout the playlist's description to find out when and where they perform.</p>
                </ol>
            </div>
        </div>
        <div class="pure-g dark-bg-1" v-if="!loading">
            <div class="pure-u-1 pure-u-md-1-3">
            </div>
            <div class="pure-u-1 pure-u-md-1-3">
                <div v-if="authNone">
                    <H2>Authorize with Spotify &#128275;</H2>
                    <p>We will send you over to spotify to login, and then spotify will give us permission to push playlists to your account. Easy as that.</p>
                </div>
                <div class="warning" v-if="authError">
                    <H2>Authorization Issue &#129320; </H2>
                    <H3>Oh no! Something went awry...</H3>
                    <p>Seems like there's a problem authenticating with spotify. This may or may not be our fault. Would you contact us and let us know you had an issue? We will try our best to fix it.</p>
                </div>
                <div class="warning" v-if="authSuccess">
                    <H2>Spotify Authorization Success &#127821; </H2>
                    <p>We've validated you with spotify. In the next step you'll build the playlist.</p>
                </div>
                <form class="pure-form" v-if="authNone || authError"> 
                    <fieldset>
                        <input type="button" value="Authorize" class="pure-button pure-button-primary"  v-on:click="authSpotify" />
                    </fieldset>
                </form>
            </div>
        </div>
        <div class="pure-g dark-bg-1" v-if="!loading && showPickCity">
            <div class="pure-u-1 pure-u-md-1-3"></div>
            <div class="pure-u-1 pure-u-md-1-3">
                <H2>Pick a city</H2>
                <p>Currently we only support a copuple of cities, but more will show up in the future. Checkout our mailing list to sign up, and show interest in bringing near hear to your town.</p>
                <form class="pure-form">
                    <fieldset >
                        <select v-model="playlist.city" v-on:change="onCitySelected" >
                            <option v-for="city in playlist.cities" v-bind:value="city" :selected="city === playlist.city">{{city}}</option>
                        </select>
                    </fieldset>
                </form>
            </div>
        </div>
        <div class="pure-g dark-bg-1" v-if="!loading && showPickDates">
            <div class="pure-u-1 pure-u-md-1-3"></div>
            <div class="pure-u-1 pure-u-md-1-3">
                <H2>Set your date range</H2>
                <p>We will build the playist based on artists playing during this time frame in {{playlist.city}}.</p>
                <form class="pure-form">
                    <fieldset >
                        <div class="datepicker-wrap">
                            <vuejs-datepicker 
                            :value="playlist.startDate" 
                            :disabled-dates="disabledDates"
                            name="startDate" 
                            placeholder="Pick Start Date" 
                            @selected="onStartDateSelected"
                            >
                        </vuejs-sdatepicker>
                    </div>
                    <div class="datepicker-wrap">
                        <vuejs-datepicker 
                        :value="playlist.endDate" 
                        :disabled-dates="disabledDates"
                        name="endDate" 
                        placeholder="Pick End Date" 
                        @selected="onEndDateSelected">
                    </vuejs-datepicker>
                </div>
                <p style="font-style: italic;">We hate to bring it up, but... due to covid-19, the show listings in the spring and summer of 2020 are very sparse. Picking dates prior to covid-19 will create a fuller playlist, and possibly take you back to better days.</p>
            </fieldset>
        </form>
    </div>
</div>
<div class="pure-g dark-bg-1" v-if="!loading && showPickFilters">
    <div class="pure-u-1 pure-u-md-1-3"></div>
            <div class="pure-u-1 pure-u-md-1-3">
                <h2>Apply Filters</h2>
                <h4>{{filteredShows}} of {{totalShows}} shows</h4>
                <div class="filter-wrapper" v-if="genres.length > 0">
                    <h3>Genres</h3>
                    <form class="pure-form">
                        <fieldset >
                            <label v-for="item in genres" v for="checkbox-radio-option-one" class="pure-checkbox">
                                <input type="checkbox" name="genres" :id="item" :value="item" v-model="checkedGenres" />{{item}}
                            </label>
                        </fieldset>
                    </form>
                </div>
                <div class="filter-wrapper" v-if="venues.length > 0">
                    <h3>Venues</h3>
                    <form class="pure-form">
                        <fieldset >
                            <label v-for="item in venues" for="checkbox-radio-option-one" class="pure-checkbox">
                                <input type="checkbox" name="venues" :id="item" :value="item" v-model="checkedVenues" />{{item}}</label>
                            </fieldset>
                    </form>
                </div>
                
            </div>
        </div>
        <div class="pure-g dark-bg-1" v-if="!loading && showCreatePlaylist">
            <div class="pure-u-1 pure-u-md-1-3"></div>
            <div class="pure-u-1 pure-u-md-1-3">
                <H2>Almost there!</H2>
                <p>All you gotta do now is press that playlist button. &#128293; </p>
                <form class="pure-form">
                    <fieldset >
                        <div v-if="playlist.sending" class="loadingio-spinner-dual-ball-ffelmax3riq"><div class="ldio-ocss36wta5n"><div></div><div></div><div></div></div></div>
                        <input type="button" value="Create Playlist" v-on:click="createPlaylist" class="pure-button pure-button-primary" :disabled="playlist.created" v-if="!playlist.sending" />
                    </fieldset>
                </form>
            </div>
        </div>
        <div class="pure-g dark-bg-1" v-if="!loading && playlist.created && playlist.status == 1">
            <div class="pure-u-1 pure-u-md-1-3">
            </div>
            <div class="pure-u-1 pure-u-md-1-3">
                <H2>Congrats! You've made a nearhear playlist. </H2>
                <p>check spotify and listen to it. Show times and info can be found in the playlist's description.
                If you went to the show, or you just liked the playlist. Let us know on instagram or twitter.</p>
                <p>instagram: @nearhear</p>
                <p>twitter: @nearhear</p>
            </div>
            <div class="pure-u-1 pure-u-md-1-3">
            </div>
        </div>
        <div class="pure-g dark-bg-1" v-if="!loading && !playlist.created && playlist.status == -1">
            <div class="pure-u-1 pure-u-md-1-3">
            </div>
            <div class="pure-u-1 pure-u-md-1-3">
                <H2>Oh no! That didn't work. :(</H2>
                <p>Would you <a href="mailto:feedback@nearhear.app">contact us</a> and let us know you had an issue? We will try our best to fix it.</p>
            </div>
            <div class="pure-u-1 pure-u-md-1-3">
            </div>
        </div>
        <div class="pure-g mid-bg">
            <div class="pure-u-1 pure-u-md-1-3">
            </div>
            <div class="pure-u-1 pure-u-md-1-3">
                <h1>Be Notified &#128036;</h1>
                <p>NearHear is currently in the works, but we will hopefully be launching more cities post-covid. Enter your email and city below to be notified when we launch in your town.</p>
                <form class="pure-form">
                    <fieldset >
                        <input type="text" id="Email" name="Email" placeholder="Your Email" v-model="notified.email" />
                        <input type="text" id="City" name="City" placeholder="Your City" v-model="notified.city"/>
                        <div v-if="notified.status == status_codes.SENDING" class="loadingio-spinner-dual-ball-ffelmax3riq"><div class="ldio-ocss36wta5n"><div></div><div></div><div></div></div></div>
                        <input v-if="notified.status != status_codes.SENDING" type="submit" value="Get Notified!" class="pure-button pure-button-primary" v-on:click="getNotified"  :disabled="notified.status == status_codes.SENDING || notified.status == status_codes.SUCCESS" />
                        <p v-if="notified.status === status_codes.SUCCESS">Thanks! We hope you'll hear from us again.</p>
                        <p v-if="notified.status === status_codes.FAILURE">Whoops, something has gone wrong :(<a href="mailto:feedback@nearhear.app">Please let us know.</a></p>
                    </fieldset>
                    </form>
            </div>
        </div>
        <div class="pure-g dark-bg">
            <div class="pure-u-1 pure-u-md-1-3">
            </div>
            <div class="pure-u-1 pure-u-md-1-3">
                <h1>Donate &#127867;</h1>
                <p>Send us some love and throw some money our way! Nearhear is currently free and in a perfect world the generousity of others would keep it this way forever!</p>
                <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top" class="pure-form">
                    <input type="hidden" name="cmd" value="_donations" />
                    <input type="hidden" name="business" value="liz@nearhear.app" />
                    <input type="hidden" name="currency_code" value="USD" />
                    <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
                    <img alt="" style="margin-left:2em" border="0" src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1" />
                </form>
            </div>
        </div>
        <div class="pure-g mid-bg">
            <div class="pure-u-1 pure-u-md-1-3">
            </div>
            <div class="pure-u-1 pure-u-md-1-3">
                <h1>Contact Us &#128227;</h1>
                <p>Questions, comments, concerns, just want to be friends? Don't be a stranger. Reach out to us <a href="mailto:feedback@nearhear.app">feedback@nearhear.app</a>.</p>
            </div>
        </div>
    </div>
    <div id="footer">Copyright 2020 Offline Development LLC</div>

    <script>
        const baseUrl = "https://nearhear.app"
        const headers = new Headers()
        const userIdCn = "spotify_user_id"
        const status_codes = {
            "FAILURE": -1,
            "NONE": 0,
            "SENDING": 1,
            "SUCCESS": 2
        }
        headers.append("Content-Type", "application/json"); 

        function setCookie(cname, cvalue, exdays) {
            var d = new Date();
            d.setTime(d.getTime() + (exdays*24*60*60*1000));
            var expires = "expires="+ d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }

        function getCookie(cname) {
          var name = cname + "=";
          var decodedCookie = decodeURIComponent(document.cookie);
          var ca = decodedCookie.split(';');
          for(var i = 0; i <ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
              c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
              return c.substring(name.length, c.length);
            }
          }
          return "";
        }

        function nhFetch(path, method, body) {
            const opts = {
                method: method,
                //credentials: 'include',
                headers: headers,
                redirect: "follow"
            }

            if (body) {
                opts.body = JSON.stringify(body)
            }

            return fetch(baseUrl + path, opts)
        }

        var app = new Vue({
          el: '#app',
          components: {
            vuejsDatepicker
          },
          data: {
            loading: true,
            tab: 'about',
            auth: {
                spotify: {
                    inOauthMode: undefined,
                    userid: undefined,
                    oauthUrl: undefined
                }
            },
            features: {
                filters: true,
                autoDateRange: true
            },
            playlist: {
                platforms: ['spotify'],
                startDate: undefined,
                endDate: undefined,
                city: undefined,
                cities: [],
                venues: [],
                status: status_codes.NONE
            },
            notified: {
                city: '',
                email: '',
                sending: false,
                status: status_codes.NONE
            },
            cities: [],
            genres: ["punk", "folk", "hip-hop", "rap", "metal", "jazz"],
            checkedGenres: ["punk", "folk", "hip-hop", "rap", "metal", "jazz"],
            venues: [],
            checkedVenues: [],
            totalShows: 0,
            filteredShows: 0,
            disabledDates: {
                from: new Date(Date.parse('2021-01-01 00:00:00')),
                to: new Date(Date.parse('2010-01-01 00:00:00'))
            },
            status_codes: status_codes
          },
          mounted: function(){
            // check user id
            const params = new URLSearchParams(window.location.search)
            const userId = this.getUserIdFromCookie()
            if (userId) {
                this.auth.spotify.userid = userId
            }
                
            // Grab current cities
            nhFetch(
                `/media/getSupportedCities`,  
                "GET")
                .then(response => response.text())
                .then(result => {
                    const obj = JSON.parse(result)
                    this.playlist.cities = obj
                    this.loading = false
                })
                .catch(error => console.log('error', error));
          },
          computed: {
              authNone: function() {
                return this.auth.spotify.userid === undefined
              },
              authSuccess: function() {
                return this.auth.spotify.userid && this.auth.spotify.userid !== 'error'
              },
              authError: function() {
                return this.auth.spotify.userid === 'error'
              },
              citySuccess: function() {
                return this.playlist.city !== undefined
              },
              dateSuccess: function() {
                return this.playlist.startDate !== undefined && this.playlist.endDate !== undefined
              },
              filterSuccess: function() {
                return this.totalShows > 0
              },
              playListLink: function() {
                return `${window.location.host}/index.html?city=${this.playlist.city}&sd=${this.playlist.startDate.toUTCString()}&ed=${this.playlist.endDate.toUTCString()}`
              },

              showPickCity: function() {
                return this.authSuccess
              },
              showPickDates: function() {
                return !!this.playlist.city
              },
              showPickFilters: function() {
                  return this.features.filters && this.playlist.endDate
              },
              showCreatePlaylist: function() {
                  return (this.features.filters && this.filteredShows > 0) ||
                         (!this.features.filters && this.playlist.endDate)
              }
          },
          methods: {
            getUserIdFromCookie: function() {
                return getCookie(userIdCn) || new URLSearchParams(window.location.search).get("userid")
            },
            navigate: function (tab) {
                this.tab = tab
            },
            authSpotify: function () {
                let authEndPoint = `${baseUrl}/spotify/auth`
                if (this.auth.spotify.userid !== undefined) {
                    authEndPoint += `?userid=${this.auth.spotify.userid}`
                }
                window.location = authEndPoint
            },
            buildPath: function() {
                let path = window.location.pathname
                let query = '?'
                if (this.playlist.city)         query += `playlist_city=${this.playlist.city}&`
                if (this.playlist.startDate)    query += `playlist_startDate=${this.playlist.startDate}&`
                if (this.playlist.endDate)      query += `playlist_endDate=${this.playlist.endDate}&`
                return path + query
            },
            onCitySelected: function(city) {
                this.playlist.created =false

                if (this.features.autoDateRange) {
                    nhFetch("/media/getDateRange", "POST", { city: this.playlist.city })
                     .then(resp => resp.text())
                     .then(result => {
                        const {startDate, endDate} = JSON.parse(result)
                        this.disalbedDates = {
                            from: Date.parse(startDate),
                            to: Date.parse(endDate)
                        }
                    })
                }
            },
            onStartDateSelected: function(date) {
                if (this.playlist.created && this.playlist.startDate !== date) {
                    this.playlist.created = false
                }
                this.playlist.startDate = date
            },
            onEndDateSelected: function(date) {
                if (this.playlist.created && this.playlist.endDate !== date) {
                    this.playlist.created = false
                }
                this.playlist.endDate = date

                const payload = {
                    startDate: this.playlist.startDate,
                    endDate: this.playlist.endDate,
                    city: this.playlist.city,
                    minShows: 0
                }

                if (this.features.filters) {

                    nhFetch("/media/getFilters", "POST", payload)
                     .then(resp => resp.text())
                     .then(result => {
                        const json = JSON.parse(result)
                        console.log("FILTERS", json)
                        
                        this.totalShows = json.totalShowss
                        this.venues = json.venues
                        this.checkedVenues = Object.assign({}, venues)
                        this.genres = json.genres
                        this.checkedGenres = Object.assign({}, genres)
                    })
                }
            },
            createPlaylist: function() {
                for (const platform of this.playlist.platforms) {
                    const payload = {
                        "Platform":"spotify",
                        "UserId": this.auth[platform].userid,
                        "City": this.playlist.city,
                        "StartDate": this.playlist.startDate,
                        "EndDate": this.playlist.endDate,
                        "DeleteExisting":false,
                        "Venues":this.playlist.Venues 
                    }
                    this.playlist.status = status_codes.SENDING
                    nhFetch("/spotify/buildPlaylist", "POST", payload)
                        .then(resp => resp.text())
                        .then(result => {
                            if (result.PlaylistCreated  && result.Success) {
                                this.playlist.startDate = status_codes.SUCCESS
                            } else {
                                this.playlist.status = status_codes.FAILURE
                            }
                            console.log(JSON.parse(result)) 
                        })                    
                }
            },
            getNotified: function() {
                const payload = {
                    email: this.notified.email,
                    city: this.notified.city 
                }
            
                this.notified.status = status_codes.SENDING
                nhFetch("/nearhear/addContact", "POST", payload)
                    .then(resp => resp.text())
                    .then(result => {
                        this.notified.status = status_codes.SUCCESS
                    })
                    .catch(() => {
                        this.notified.status = status_codes.FAILURE
                    })
            }
          }
        })
    </script>
  </body>

</html>
